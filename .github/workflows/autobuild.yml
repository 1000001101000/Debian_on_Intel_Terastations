name: Generate new images if needed

on:
  push:
    paths:
      - '.rebuild'
  schedule:
      - cron: "15 * * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    container: 'debian:12'
    env:
      build_needed: no
      versions: "Bullseye Bookworm"
    steps:
    - name: checkout via standard action
      uses: actions/checkout@v4

    - name: check rebuild flag
      run: echo "build_needed=$(cat .rebuild)" >> $GITHUB_ENV

    - name: update images if needed
      if: env.build_needed == 'yes'
      run: |
        set -e
        apt-get update
        apt-get -y install curl gzip rsync wget cpio mtools git isolinux xz-utils xorriso syslinux-utils genisoimage
        git config user.name "workflow@github"; git config user.email "workflow@github"
        for x in ${{env.versions}}; do
        cd "installer-image/$x/build/"
        ./generate_images.sh
        cp output/*.iso installer-image/$x/
        cat debian-files/initrd.gz | md5sum > last_build.txt
        cd -; done
        echo no > .rebuild
        git config user.name "workflow@github"; git config user.email "workflow@github"
        git commit -v -a -m "update installer images"
        git push https://${{github.actor}}:${{secrets.GITHUB_TOKEN}}@github.com/${{github.repository}}.git HEAD:master
