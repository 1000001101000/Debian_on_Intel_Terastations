name: Generate new images if any components changed

on: [push]
  #schedule: 
    #- cron: 32 20 * * *

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      repo_dir: .
      build_needed: no
    steps: 
    
    ##check for build flag, 
    - name: check for the build needed flag
      run: echo "::set-output name=build_needed::$(curl -sL "https://github.com/1000001101000/Debian_on_Intel_Terastations/raw/master/.rebuild" 2>/dev/null)"  
      
    - name: update apt
      if: env.build_needed == 'yes'
      run: sudo apt-get update || exit 0
      
    - name: ensure build packages are installed
      if: env.build_needed == 'yes'
      run: sudo apt-get install gzip rsync wget cpio grub2 xorriso mtools
    
    - name: if needed, clone the repo for build
      if: env.build_needed == 'yes'
      run: git clone https://github.com/${{github.repository}}; echo "::set-env name=repo_dir::$(ls -rt | tail -n 1)"
    
    - name: set git user name
      if: env.build_needed == 'yes'
      run: git config user.name "workflow@github"; git config user.email "workflow@github"
      working-directory: "${{env.repo_dir}}"
    
    - name: build stretch installer
      if: env.build_needed == 'yes'
      run: cd installer-image/Stretch/build/; sudo ./build.sh
      working-directory: "${{env.repo_dir}}"
    
    - name: copy stretch image to repo
      if: env.build_needed == 'yes'
      run: cp installer-image/Stretch/build/output/*.iso installer-image/Stretch/
      working-directory: "${{env.repo_dir}}"
      
    - name: build buster installer
      if: env.build_needed == 'yes'
      run: cd installer-image/Buster/build/; sudo ./build.sh
      working-directory: "${{env.repo_dir}}"
    
    - name: clear rebuild needed flag 
      if: env.build_needed == 'no'
      run: echo yes > .rebuild
      working-directory: "${{env.repo_dir}}"
      
    - name: if needed, commit
      if: env.build_needed == 'yes'
      run: git commit -a -m "update files from external projects"
      working-directory: "${{env.repo_dir}}"
  
  #  - name: commit new images
  #    if: steps.build_images.outputs.commit_needed == 'yes'
  #    run: git push https://${{github.actor}}:${{secrets.GITHUB_TOKEN}}@github.com/${{github.repository}}.git HEAD:master
      
